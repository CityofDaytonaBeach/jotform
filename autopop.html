<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">

    <!-- Load JotForm Widget API -->
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>

    <!-- Force Jotform default input styling -->
    <style>
        body {
            font-family: Inter, Arial, sans-serif;
            margin: 0;
            padding: 8px;
            background: transparent;
        }

        /* Match Jotform V4 fields */
        .jf-field .form-textbox {
            width: 100%;
            padding: 10px;
            border: 1px solid #d0d0d7;
            border-radius: 4px;
            font-size: 15px;
        }

        #resultsContainer {
            width: 100%;
        }

        .dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #fff;
            border: 1px solid #ccc;
            z-index: 99999;
            max-height: 180px;
            overflow-y: auto;
            border-radius: 4px;
        }

        .dropdown-item {
            padding: 8px;
            cursor: pointer;
        }

        .dropdown-item:hover {
            background: #f5f5f7;
        }
    </style>
</head>

<body>
<div id="resultsContainer" class="jf-field form-input-wide">
    <input
        id="searchUser"
        type="text"
        class="form-textbox"
        placeholder="Search employee..."
        autocomplete="off"
    />
</div>

<script>
/* ----------------------------------------------------------
   CONFIGURATION
---------------------------------------------------------- */
const SUPABASE_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";

const fieldMap = {
    fullName: 4,
    email: 5,
    jobTitle: 6,
    department: 7,
    manager: 8,
    managerEmail: 9,
    employeeId: 10,
    division: 11
};

let employees = [];
let selected = null;

/* ----------------------------------------------------------
   LOAD EMPLOYEE DATA
---------------------------------------------------------- */
async function loadEmployees() {
    try {
        const res = await fetch(SUPABASE_URL);
        employees = await res.json();

        console.log("✔ Employees loaded:", employees.length);
    } catch (err) {
        console.error("❌ Failed to fetch Supabase data:", err);
    }
}

loadEmployees();

/* ----------------------------------------------------------
   AUTOCOMPLETE / MATCHING
---------------------------------------------------------- */
const input = document.getElementById("searchUser");
const container = document.getElementById("resultsContainer");
let timer = null;

input.addEventListener("input", (e) => {
    clearTimeout(timer);
    const value = e.target.value.trim().toLowerCase();

    timer = setTimeout(() => searchEmployees(value), 150);
});

function searchEmployees(query) {
    container.querySelectorAll(".dropdown").forEach(d => d.remove());

    if (!query) return;

    const matches = employees
        .filter(emp =>
            (emp.displayname || "").toLowerCase().includes(query)
        )
        .slice(0, 8);

    if (!matches.length) return;

    const dd = document.createElement("div");
    dd.className = "dropdown";

    matches.forEach(emp => {
        const item = document.createElement("div");
        item.className = "dropdown-item";
        item.textContent = emp.displayname;

        item.onclick = () => {
            selected = emp;
            input.value = emp.displayname;
            dd.remove();
            autofill(emp);
        };

        dd.appendChild(item);
    });

    container.appendChild(dd);
}

/* ----------------------------------------------------------
   AUTOFILL INTO JOTFORM
---------------------------------------------------------- */
function autofill(emp) {

    const data = [
        { id: fieldMap.fullName, value: emp.displayname },
        { id: fieldMap.email, value: emp.mail },
        { id: fieldMap.jobTitle, value: emp.jobtitle },
        { id: fieldMap.department, value: emp.department },
        { id: fieldMap.manager, value: emp.manager },
        { id: fieldMap.managerEmail, value: emp.managermail },
        { id: fieldMap.employeeId, value: emp.employeeId },
        { id: fieldMap.division, value: emp.division }
    ];

    console.log("➡ Pushing data to Jotform:", data);

    try {
        JFCustomWidget.setFieldsValueById(data);
    } catch (err) {
        console.error("❌ setFieldsValueById failed:", err);
    }

    // Widget value
    JFCustomWidget.sendData({ valid: true, value: emp.displayname });
}

/* ----------------------------------------------------------
   JOTFORM WIDGET EVENTS
---------------------------------------------------------- */
JFCustomWidget.subscribe("ready", function () {
    console.log("✔ Widget ready");
    JFCustomWidget.sendData({ valid: true, value: "" });
});

JFCustomWidget.subscribe("submit", function () {
    JFCustomWidget.sendSubmit({
        valid: true,
        value: selected ? selected.displayname : ""
    });
});
</script>
</body>
</html>
