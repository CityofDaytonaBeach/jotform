<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>

    <style>
        body { font-family: Inter, Arial, sans-serif; margin: 0; padding: 8px; }
        #resultsContainer { width: 100%; position: relative; }
        input.form-textbox {
            width: 100%; padding: 10px;
            border: 1px solid #d0d0d7; border-radius: 4px;
            font-size: 15px;
        }
        .dropdown {
            position: absolute; top: 100%; left: 0; right: 0;
            background: #fff; border: 1px solid #ccc;
            z-index: 99999; max-height: 200px; overflow-y: auto;
        }
        .dropdown-item { padding: 8px; cursor: pointer; }
        .dropdown-item:hover { background: #f5f5f7; }
    </style>
</head>

<body>
<div id="resultsContainer">
    <input id="searchUser" class="form-textbox" type="text" placeholder="Search employee..." autocomplete="off">
</div>

<script>
/* ---------------------------------------------------
   DIAGNOSTIC LOGGER
--------------------------------------------------- */
function logInfo(...msg){ console.log("%cINFO","color:#0a0",...msg); }
function logWarn(...msg){ console.warn("%cWARN","color:#cc0",...msg); }
function logErr(...msg){ console.error("%cERROR","color:#c00",...msg); }
function logStep(step){ console.log("%c*** "+step+" ***","background:#333;color:#fff;padding:2px"); }

/* ---------------------------------------------------
   CONFIG
--------------------------------------------------- */
const SUPABASE_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";

const fieldMap = {
    fullName: 4,
    email: 5,
    jobTitle: 6,
    department: 7,
    manager: 8,
    managerEmail: 9,
    employeeId: 10,
    division: 11
};

logStep("Widget Booting");
logInfo("Field map:", fieldMap);

/* ---------------------------------------------------
   LOAD EMPLOYEES
--------------------------------------------------- */
let employees = [];
let selectedUser = null;

async function loadEmployees() {
    logStep("Fetching Supabase Data");
    logInfo("Requesting:", SUPABASE_URL);

    try {
        const res = await fetch(SUPABASE_URL);

        logInfo("Fetch Response Status:", res.status);

        if (!res.ok) {
            logErr("Fetch failed:", res.status, res.statusText);
            return;
        }

        const json = await res.json();

        if (!Array.isArray(json)) {
            logErr("Supabase returned NON-array JSON:", json);
            return;
        }

        employees = json;
        logInfo("Loaded employees:", employees.length);

        console.table(employees);

    } catch (err) {
        logErr("Supabase fetch error:", err);
    }
}

loadEmployees();

/* ---------------------------------------------------
   AUTOCOMPLETE SEARCH
--------------------------------------------------- */
const input = document.getElementById("searchUser");
const container = document.getElementById("resultsContainer");
let debounce = null;

input.addEventListener("input", e => {
    clearTimeout(debounce);
    debounce = setTimeout(() => {
        logStep("Search Triggered");
        const q = e.target.value.trim().toLowerCase();
        logInfo("Query:", q);

        handleSearch(q);
    }, 150);
});

function handleSearch(query) {
    container.querySelectorAll(".dropdown").forEach(d => d.remove());
    if (!query){
        logWarn("Empty search query");
        return;
    }

    const matches = employees.filter(u =>
        (u.displayname || "").toLowerCase().includes(query)
    );

    logInfo("Match count:", matches.length);

    if (!matches.length) {
        logWarn("No matches found");
        return;
    }

    const dd = document.createElement("div");
    dd.className = "dropdown";

    matches.forEach(u => {
        const item = document.createElement("div");
        item.className = "dropdown-item";
        item.textContent = u.displayname;

        item.onclick = () => {
            logStep("User Selected");
            console.table(u);

            selectedUser = u;
            input.value = u.displayname;
            dd.remove();

            autofill(u);
        };

        dd.appendChild(item);
    });

    container.appendChild(dd);
    logInfo("Dropdown rendered with", matches.length, "items");
}

/* ---------------------------------------------------
   JOTFORM AUTOFILL
--------------------------------------------------- */
function autofill(u) {
    logStep("Autofill Start");
    const data = [
        { id: fieldMap.fullName, value: u.displayname },
        { id: fieldMap.email, value: u.mail },
        { id: fieldMap.jobTitle, value: u.jobtitle },
        { id: fieldMap.department, value: u.department },
        { id: fieldMap.manager, value: u.manager },
        { id: fieldMap.managerEmail, value: u.managermail },
        { id: fieldMap.employeeId, value: u.employeeId },
        { id: fieldMap.division, value: u.division }
    ];

    console.table(data);

    try {
        JFCustomWidget.setFieldsValueById(data);
        logInfo("setFieldsValueById executed");
    } catch (err) {
        logErr("setFieldsValueById crashed:", err);
    }

    JFCustomWidget.sendData({ valid: true, value: u.displayname });
}

/* ---------------------------------------------------
   JOTFORM EVENTS
--------------------------------------------------- */
JFCustomWidget.subscribe("ready", function() {
    logStep("JF Widget READY");
    JFCustomWidget.sendData({ valid: true, value: "" });
});

JFCustomWidget.subscribe("submit", function() {
    logStep("Form SUBMIT Event");
    JFCustomWidget.sendSubmit({
        valid: true,
        value: selectedUser ? selectedUser.displayname : ""
    });
});
</script>

</body>
</html>
