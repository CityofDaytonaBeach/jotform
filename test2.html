<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>

  <style>
    #searchBox {
      width: 100%;
      padding: 10px;
      margin-bottom: 5px;
      font-size: 15px;
      box-sizing: border-box;
    }

    #resultList {
      width: 100%;
      max-height: 200px;
      border: 1px solid #ccc;
      border-top: none;
      background: white;
      overflow-y: auto;
      display: none;
      position: absolute;
      z-index: 9999;
    }

    .result-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .result-item:hover {
      background: #f4f4f4;
    }

    .wrapper {
      position: relative;
      width: 100%;
    }
  </style>
</head>

<body>

<div class="wrapper">
  <input type="text" id="searchBox" placeholder="Search employees by full name‚Ä¶">
  <div id="resultList"></div>
</div>

<script>
/*--------------------------------------------------------------
   EMPLOYEE SEARCH + AUTOFILL WIDGET
--------------------------------------------------------------*/
function EmployeeWidget() {

  this.init = init;
  this.getData = getData;

  let employees = [];
  let selectedEmployee = null;

  /*----------------------------------------------------------
     INIT: Called after Jotform iframe is ready
  ----------------------------------------------------------*/
  async function init(formData) {
    console.log("üü¢ Widget initialized.");

    employees = await loadEmployees();
    console.log("üî• EMPLOYEE PAYLOAD:", employees);

    if (!employees || employees.length === 0) {
      console.error("‚ùå No employees loaded. Supabase or CORS issue likely.");
    }

    activateSearch();
  }

  /*----------------------------------------------------------
     LOAD EMPLOYEES FROM SUPABASE
  ----------------------------------------------------------*/
  async function loadEmployees() {
    try {
      const res = await fetch(
        "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users",
        { method: "GET", headers: { "Content-Type": "application/json" } }
      );

      if (!res.ok) {
        console.error("‚ùå Supabase error status:", res.status);
        return [];
      }

      const data = await res.json();
      return data;
    } catch (err) {
      console.error("‚ùå Network or CORS error:", err);
      return [];
    }
  }

  /*----------------------------------------------------------
     AUTOCOMPLETE SEARCH BEHAVIOR
  ----------------------------------------------------------*/
  function activateSearch() {
    const searchBox = document.getElementById("searchBox");
    const resultList = document.getElementById("resultList");

    console.log("üîß Search activated. Employee count:", employees.length);

    searchBox.addEventListener("input", () => {
      const query = searchBox.value.toLowerCase().trim();
      resultList.innerHTML = "";

      console.log("üîé User typed:", query);

      if (!query) {
        resultList.style.display = "none";
        return;
      }

      const filtered = employees.filter(emp =>
        emp.displayname &&
        emp.displayname.toLowerCase().includes(query)
      );

      console.log("üìâ Filtered matches:", filtered);

      if (filtered.length === 0) {
        resultList.style.display = "none";
        return;
      }

      filtered.forEach(emp => {
        const div = document.createElement("div");
        div.classList.add("result-item");
        div.textContent = emp.displayname;

        div.onclick = () => {
          console.log("üë§ Employee SELECTED:", emp);

          selectedEmployee = emp;
          searchBox.value = emp.displayname;
          resultList.style.display = "none";

          autopopulate(emp);
        };

        resultList.appendChild(div);
      });

      resultList.style.display = "block";
    });

    document.addEventListener("click", e => {
      if (!e.target.closest(".wrapper")) {
        resultList.style.display = "none";
      }
    });
  }

  /*----------------------------------------------------------
     AUTOFILL INTO JOTFORM FIELDS
  ----------------------------------------------------------*/
  function autopopulate(emp) {
    console.log("üöÄ Autopopulating fields with:", emp);

    const fieldMap = [
      { id: "input_5",  value: emp.displayname }, // Full Name
      { id: "input_6",  value: emp.mail },
      { id: "input_7",  value: emp.jobtitle },
      { id: "input_8",  value: emp.department },
      { id: "input_9",  value: emp.manager },
      { id: "input_10", value: emp.managermail },
      { id: "input_11", value: emp.employeeId },
      { id: "input_12", value: emp.division }
    ];

    try {
      JFCustomWidget.setFieldsValueById(fieldMap);
      console.log("‚úÖ Autopopulation completed.");
    } catch (e) {
      console.error("‚ùå Jotform autopopulation failed:", e);
    }
  }

  /*----------------------------------------------------------
     SUBMIT PAYLOAD
  ----------------------------------------------------------*/
  function getData() {
    return {
      valid: true,
      value: selectedEmployee ? selectedEmployee.displayname : ""
    };
  }
}

/*--------------------------------------------------------------
   JOTFORM WIDGET EVENT BINDINGS
--------------------------------------------------------------*/
JFCustomWidget.subscribe("ready", function (data) {
  const widget = new EmployeeWidget();
  widget.init(data);

  JFCustomWidget.subscribe("submit", function () {
    JFCustomWidget.sendSubmit(widget.getData());
  });
});
</script>

</body>
</html>
