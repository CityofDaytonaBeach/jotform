<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Search Widget</title>
<script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>
<style>
  body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
  }
  #resultsContainer {
    position: relative;
    width: 100%;
  }
  #searchUser {
    width: 100%;
    padding: 4px;
    margin: 0;
    box-sizing: border-box;
  }
  .dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #ccc;
    z-index: 9999;
    max-height: 180px;
    overflow-y: auto;
  }
  .dropdown-item {
    cursor: pointer;
    padding: 2px 4px;
    margin: 0;
  }
  .dropdown-item:hover {
    background: #f0f0f0;
  }
</style>
</head>
<body>
  <div id="resultsContainer">
    <input type="text" id="searchUser" placeholder="Search employee..." autocomplete="off" />
  </div>

<script>
let users = [];

document.addEventListener("DOMContentLoaded", async () => {
  const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";
  const searchInput = document.getElementById("searchUser");
  const resultsContainer = document.getElementById("resultsContainer");

  console.log("ðŸ” Jotform widget loading...");

  try {
    const res = await fetch(API_URL);
    users = await res.json();
    console.log(`âœ… Loaded ${users.length} users`);
  } catch (err) {
    console.error("âŒ Error fetching users:", err);
  }

  if (!Array.isArray(users) || users.length === 0) {
    console.warn("âš ï¸ No users loaded");
    return;
  }

  searchInput.addEventListener("input", (e) => {
    const query = e.target.value.trim().toLowerCase();
    resultsContainer.querySelectorAll(".dropdown").forEach(d => d.remove());
    if (!query) return;

    const matches = users.filter(u =>
      (u.full_name || "").toLowerCase().includes(query)
    ).slice(0, 8);

    if (matches.length === 0) return;

    const dropdown = document.createElement("div");
    dropdown.className = "dropdown";

    matches.forEach(u => {
      const item = document.createElement("div");
      item.className = "dropdown-item";
      item.textContent = u.full_name || "(No Name)";
      item.addEventListener("click", () => {
        searchInput.value = u.full_name || "";
        dropdown.remove();
        console.log("âœ… Selected:", u);

        // Autofill Jotform fields
        const fields = {
          "#input_5": u.full_name,
          "#input_6": u.email,
          "#input_7": u.job_title,
          "#input_8": u.department,
          "#input_9": u.manager,
          "#input_10": u.manager_email,
          "#input_11": u.employee_id,
          "#input_12": u.division
        };
        for (const [sel, val] of Object.entries(fields)) {
          const el = parent.document.querySelector(sel);
          if (el) el.value = val || "";
        }

        // Send data back to Jotform
        if (window.JFCustomWidget) {
          JFCustomWidget.sendData({
            valid: true,
            value: JSON.stringify(u)
          });
        }
      });
      dropdown.appendChild(item);
    });

    resultsContainer.appendChild(dropdown);
  });

  document.addEventListener("click", (e) => {
    if (!resultsContainer.contains(e.target) && e.target !== searchInput) {
      resultsContainer.querySelectorAll(".dropdown").forEach(d => d.remove());
    }
  });
});

// Jotform widget integration
if (window.JFCustomWidget) {
  JFCustomWidget.subscribe("ready", function (msg) {
    console.log("âœ… Jotform Widget Ready");
  });
}
</script>
</body>
</html>
