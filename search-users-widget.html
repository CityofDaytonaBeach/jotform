<!DOCTYPE html>
<html>
<head>
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
  <style>
    body {
      font-family: sans-serif;
      padding: 10px;
    }
    input, select {
      width: 100%;
      padding: 8px;
      margin-bottom: 10px;
      box-sizing: border-box;
    }
  </style>
</head>
<body>
  <h3>Employee Directory</h3>
  <input type="text" id="searchBox" placeholder="Search by Lastname, Firstname">
  <select id="userSelect" size="8">
    <option value="">Loading users...</option>
  </select>
  <p id="status"></p>

  <script>
    const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";
    let allUsers = [];

    async function loadUsers() {
      try {
        document.getElementById('status').textContent = "Fetching users...";
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const users = await res.json();

        // Sort users alphabetically by last name
        users.sort((a, b) => {
          const aLast = a.displayname?.split(' ').pop()?.toLowerCase() || '';
          const bLast = b.displayname?.split(' ').pop()?.toLowerCase() || '';
          return aLast.localeCompare(bLast);
        });

        allUsers = users;
        renderUserList(users);
        document.getElementById('status').textContent = `Loaded ${users.length} users.`;
      } catch (e) {
        document.getElementById('status').textContent = `Error loading users: ${e.message}`;
      }
    }

    // Render the dropdown list
    function renderUserList(users) {
      const select = document.getElementById('userSelect');
      select.innerHTML = "";
      if (users.length === 0) {
        select.innerHTML = '<option value="">No matches found</option>';
        return;
      }
      users.forEach(u => {
        const opt = document.createElement('option');
        const nameParts = u.displayname ? u.displayname.trim().split(' ') : [''];
        const firstName = nameParts[0] || '';
        const lastName = nameParts[nameParts.length - 1] || '';
        opt.value = JSON.stringify(u);
        opt.textContent = `${lastName}, ${firstName} (${u.department})`;
        select.appendChild(opt);
      });
    }

    // Search filter
    function filterUsers() {
      const query = document.getElementById('searchBox').value.toLowerCase();
      const filtered = allUsers.filter(u => {
        const name = u.displayname ? u.displayname.toLowerCase() : '';
        const formatted = name.split(' ').reverse().join(', ');
        return (
          name.includes(query) ||
          formatted.includes(query) ||
          (u.department && u.department.toLowerCase().includes(query))
        );
      });
      renderUserList(filtered);
    }

    // Send selected user data to Jotform
    function handleSelection() {
      const selected = document.getElementById('userSelect').value;
      if (!selected) {
        JFCustomWidget.sendData({ value: "" });
        return;
      }
      const user = JSON.parse(selected);
      JFCustomWidget.sendData({ value: user });
    }

    // On form submit
    function handleSubmit() {
      const selected = document.getElementById('userSelect').value;
      const msg = {
        valid: !!selected,
        value: selected || ""
      };
      JFCustomWidget.sendSubmit(msg);
    }

    // Initialize widget
    JFCustomWidget.subscribe("ready", function() {
      loadUsers();
      document.getElementById('searchBox').addEventListener('input', filterUsers);
      document.getElementById('userSelect').addEventListener('change', handleSelection);
      JFCustomWidget.subscribe("submit", handleSubmit);
    });
  </script>
</body>
</html>
