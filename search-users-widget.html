<!doctype html>
<html>
  <head>
    <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="pragma" content="no-cache" />
  </head>

  <body>
    <input 
      id="employeeSearch" 
      placeholder="Search employee..." 
      autocomplete="off"
      style="width:100%;padding:6px;border:1px solid #ccc;border-radius:4px;"
    />

    <div id="dropdown"></div>

    <script type="text/javascript">
      const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";
      let users = [];
      let selectedEmployee = null;

      async function loadUsers() {
        try {
          const res = await fetch(API_URL);
          users = await res.json();
          console.log("ðŸ“¦ Loaded employees:", users);
        } catch (err) {
          console.error("âŒ Error loading users:", err);
        }
      }
      loadUsers();

      function createDropdown(matches) {
        const container = document.getElementById("dropdown");
        container.innerHTML = "";
        container.style.position = "relative";

        const list = document.createElement("div");
        list.style.position = "absolute";
        list.style.top = "100%";
        list.style.left = "0";
        list.style.right = "0";
        list.style.border = "1px solid #ccc";
        list.style.background = "#fff";
        list.style.zIndex = "9999";
        list.style.maxHeight = "180px";
        list.style.overflowY = "auto";

        matches.forEach(u => {
          const item = document.createElement("div");
          item.textContent = u.displayname || "(No Name)";
          item.style.padding = "6px";
          item.style.cursor = "pointer";

          item.addEventListener("click", () => {
            console.log("ðŸŸ¢ Selected employee:", u);
            selectedEmployee = u;

            document.getElementById("employeeSearch").value = u.displayname;
            container.innerHTML = "";

            autoFillEmployee(u);
          });

          item.addEventListener("mouseover", () => {
            item.style.background = "#f0f0f0";
          });
          item.addEventListener("mouseout", () => {
            item.style.background = "#fff";
          });

          list.appendChild(item);
        });

        container.appendChild(list);
      }

      function autoFillEmployee(emp) {
        // Build pipe-delimited output for the widget's value
        const output = [
          emp.displayname || "",
          emp.email || "",
          emp.title || "",
          emp.department || "",
          emp.manager || "",
          emp.manager_email || "",
          emp.employee_id || "",
          emp.division || ""
        ].join("|");

        console.log("ðŸ“¤ Widget Output Value:", output);

        // Autofill other fields via Jotform-supported API
        const fieldMap = [
          { id: "6", value: emp.displayname || "" },       // Full Name
          { id: "7", value: emp.email || "" },            // Email
          { id: "8", value: emp.title || "" },            // Job Title
          { id: "9", value: emp.department || "" },       // Department
          { id: "10", value: emp.manager || "" },         // Manager
          { id: "11", value: emp.manager_email || "" },   // Manager Email
          { id: "12", value: emp.employee_id || "" },     // Employee ID
          { id: "13", value: emp.division || "" }         // Division
        ];

        console.log("ðŸ“¥ Autofilling form fields:", fieldMap);

        JFCustomWidget.setFieldsValueById(fieldMap);

        // Store widgetâ€™s own value
        JFCustomWidget.storeToField("widget_input", output);
      }

      function GCLIDExample() {
        this.init = init;
        this.getData = getData;

        function init(formData) {
          console.log("ðŸŸ¦ Widget Ready â€” Initialization Complete");

          document
            .getElementById("employeeSearch")
            .addEventListener("input", (e) => {
              const q = e.target.value.toLowerCase().trim();
              if (!q) return (document.getElementById("dropdown").innerHTML = "");

              const matches = users
                .filter(u => (u.displayname || "").toLowerCase().includes(q))
                .slice(0, 8);

              console.log("ðŸ”Ž Search:", q, "| Matches:", matches.length);

              createDropdown(matches);
            });
        }

        function getData() {
          const value = selectedEmployee
            ? [
                selectedEmployee.displayname,
                selectedEmployee.email,
                selectedEmployee.title,
                selectedEmployee.department,
                selectedEmployee.manager,
                selectedEmployee.manager_email,
                selectedEmployee.employee_id,
                selectedEmployee.division
              ].join("|")
            : "";

          console.log("ðŸ“¨ sendSubmit payload:", value);

          return { valid: true, value: value };
        }
      }

      JFCustomWidget.subscribe("ready", function (data) {
        const widget = new GCLIDExample();
        widget.init(data);

        JFCustomWidget.subscribe("submit", function () {
          JFCustomWidget.sendSubmit(widget.getData());
        });
      });
    </script>
  </body>
</html>
