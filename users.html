<!doctype html>
<html>
<head>
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
  <style>
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: auto;
      overflow: visible;
      font-family: Arial, sans-serif;
    }
  </style>
</head>

<body>

<script>
const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";

let users = [];
let selectedEmployee = null;

// Load Supabase employees
async function loadUsers() {
  const res = await fetch(API_URL);
  users = await res.json();
  console.log("Loaded employees:", users.length);
}

// Build widget UI inside Jotformâ€™s approved container
function buildUI() {
  const root = JFCustomWidget.getContainer();
  root.style.width = "100%";
  root.style.padding = "6px";

  const input = document.createElement("input");
  input.id = "empSearch";
  input.placeholder = "Search employee...";
  input.style.width = "100%";
  input.style.padding = "8px";
  input.style.border = "1px solid #ccc";
  input.style.borderRadius = "4px";

  const dropdown = document.createElement("div");
  dropdown.id = "dropdown";
  dropdown.style.position = "relative";

  root.appendChild(input);
  root.appendChild(dropdown);

  input.addEventListener("input", () => {
    const query = input.value.toLowerCase().trim();
    if (!query) return dropdown.innerHTML = "";

    const matches = users.filter(u =>
      (u.displayname || "").toLowerCase().includes(query)
    ).slice(0, 10);

    renderDropdown(matches);
  });
}

// Build dropdown list
function renderDropdown(matches) {
  const dropdown = document.getElementById("dropdown");
  dropdown.innerHTML = "";

  const list = document.createElement("div");
  list.style.position = "absolute";
  list.style.top = "100%";
  list.style.left = "0";
  list.style.right = "0";
  list.style.background = "white";
  list.style.border = "1px solid #ccc";
  list.style.zIndex = "9999";
  list.style.maxHeight = "200px";
  list.style.overflowY = "auto";

  matches.forEach(emp => {
    const item = document.createElement("div");
    item.textContent = emp.displayname;
    item.style.padding = "6px";
    item.style.cursor = "pointer";

    item.onclick = () => {
      selectedEmployee = emp;
      document.getElementById("empSearch").value = emp.displayname;
      dropdown.innerHTML = "";
      autofill(emp);
    };

    item.onmouseover = () => item.style.background = "#eee";
    item.onmouseout = () => item.style.background = "#fff";

    list.appendChild(item);
  });

  dropdown.appendChild(list);
}

// Fill Jotform fields
function autofill(emp) {
  const fieldMap = [
    { id: "5", value: emp.displayname || "" },    // FULL NAME
    { id: "6", value: emp.mail || "" },           // Email
    { id: "7", value: emp.jobtitle || "" },       // Job Title
    { id: "8", value: emp.department || "" },     // Department
    { id: "9", value: emp.manager || "" },        // Manager
    { id: "10", value: emp.managermail || "" },   // Manager Email
    { id: "11", value: emp.employeeId || "" },    // Employee ID
    { id: "12", value: emp.division || "" }       // Division
  ];

  console.log("Autofill map:", fieldMap);
  JFCustomWidget.setFieldsValueById(fieldMap);

  // Pipe data for the widget's stored value
  const pipe = [
    emp.displayname, emp.mail, emp.jobtitle,
    emp.department, emp.manager, emp.managermail,
    emp.employeeId, emp.division
  ].join("|");

  JFCustomWidget.storeToField("widget_input", pipe);
}

// Widget engine
function Widget() {
  this.init = async function() {
    await loadUsers();
    buildUI();
  };

  this.getData = function() {
    if (!selectedEmployee) return { valid: true, value: "" };
    const e = selectedEmployee;

    return {
      valid: true,
      value: [
        e.displayname, e.mail, e.jobtitle,
        e.department, e.manager, e.managermail,
        e.employeeId, e.division
      ].join("|")
    };
  };
}

// Jotform lifecycle
JFCustomWidget.subscribe("ready", () => {
  const widget = new Widget();
  widget.init();

  JFCustomWidget.subscribe("submit", () => {
    JFCustomWidget.sendSubmit(widget.getData());
  });
});
</script>

</body>
</html>
