<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Employee Search Dropdown (Debug Version)</title>

  <style>
    #searchBox {
      width: 100%;
      padding: 10px;
      margin-bottom: 5px;
      font-size: 15px;
      box-sizing: border-box;
    }

    #resultList {
      width: 100%;
      max-height: 200px;
      border: 1px solid #ccc;
      border-top: none;
      background: white;
      overflow-y: auto;
      display: none;
      position: absolute;
      z-index: 9999;
    }

    .result-item {
      padding: 10px;
      cursor: pointer;
      border-bottom: 1px solid #eee;
    }

    .result-item:hover {
      background: #f4f4f4;
    }

    .wrapper {
      position: relative;
      width: 100%;
    }
  </style>
</head>

<body>

<div class="wrapper">
  <input type="text" id="searchBox" placeholder="Search by first or last name...">
  <div id="resultList"></div>
</div>

<script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>

<script>
/* ------------------------------------------------------------------------
   ENVIRONMENT CHECK
------------------------------------------------------------------------ */
console.log("üîß Widget script loaded.");
console.log("üîç Window top === Window self?", window.top === window.self ? "NOT in iframe (bad)" : "Inside iframe (good)");

/* ------------------------------------------------------------------------
   LOAD EMPLOYEES FROM SUPABASE
------------------------------------------------------------------------ */
async function loadEmployees() {
  console.log("üåê Fetching employees from Supabase...");

  try {
    const res = await fetch("https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users", {
      method: "GET",
      headers: { "Content-Type": "application/json" }
    });

    console.log("üåê Supabase response status:", res.status);

    const data = await res.json();
    console.log("üì¶ Loaded employee dataset:", data);

    return data;
  } catch (e) {
    console.error("‚ùå Error loading employees:", e);
    return [];
  }
}

/* ------------------------------------------------------------------------
   SEARCH UI + FILTERING + SELECTION LOGGING
------------------------------------------------------------------------ */
async function initSearch() {
  console.log("üîß initSearch() started");

  const employees = await loadEmployees();
  console.log("üìä Total employees loaded:", employees.length);

  const searchBox = document.getElementById("searchBox");
  const resultList = document.getElementById("resultList");

  searchBox.addEventListener("input", () => {
    const query = searchBox.value.toLowerCase().trim();
    resultList.innerHTML = "";

    console.log("üîé Search query:", query);

    if (!query) {
      console.log("üîï Query empty, hiding results.");
      resultList.style.display = "none";
      return;
    }

    const filtered = employees.filter(emp =>
      emp.displayname.toLowerCase().includes(query)
    );

    console.log("üìâ Filtered results:", filtered);

    filtered.forEach(emp => {
      const div = document.createElement("div");
      div.classList.add("result-item");
      div.textContent = emp.displayname;

      div.onclick = () => {
        console.log("üë§ Employee selected:", emp);

        searchBox.value = emp.displayname;
        resultList.style.display = "none";

        const mappedFields = {
          fullName: emp.displayname,
          email: emp.mail,
          jobTitle: emp.jobtitle,
          department: emp.department,
          manager: emp.manager,
          managerEmail: emp.managermail,
          employeeId: emp.employeeId,
          division: emp.division
        };

        console.log("üìå Autopopulating these fields:", mappedFields);

        autopopulateFields(mappedFields);
      };

      resultList.appendChild(div);
    });

    resultList.style.display = filtered.length ? "block" : "none";
  });

  document.addEventListener("click", e => {
    if (!e.target.closest(".wrapper")) {
      resultList.style.display = "none";
    }
  });
}

/* ------------------------------------------------------------------------
   AUTOFILL LOGIC + DEBUGGING JOTFORM API CALLS
------------------------------------------------------------------------ */
function autopopulateFields(mappedFields) {
  console.log("üöÄ autopopulateFields() called.");

  const fieldMap = {
    fullName: "input_5",
    email: "input_6",
    jobTitle: "input_7",
    department: "input_8",
    manager: "input_9",
    managerEmail: "input_10",
    employeeId: "input_11",
    division: "input_12"
  };

  Object.entries(mappedFields).forEach(([key, value]) => {
    const fieldId = fieldMap[key];

    console.log(`‚û°Ô∏è Preparing to populate ${key} (${fieldId}) with value:`, value);

    if (!fieldId) {
      console.warn("‚ö†Ô∏è No field ID found for:", key);
      return;
    }

    try {
      console.log("üì® Calling JFCustomWidget.storeToField:", fieldId, value);
      JFCustomWidget.storeToField(fieldId, value);
      console.log("‚úÖ Field updated successfully.");
    } catch (e) {
      console.error("‚ùå JotForm rejected field update:", e);
    }
  });
}

/* ------------------------------------------------------------------------
   JOTFORM WIDGET BINDINGS
------------------------------------------------------------------------ */
JFCustomWidget.subscribe("ready", function (data) {
  console.log("üü¢ JotForm widget READY");
  console.log("üì¶ Widget initial data from form:", data);

  initSearch();
});

JFCustomWidget.subscribe("submit", function () {
  console.log("üì® JotForm submit event triggered.");

  JFCustomWidget.sendSubmit({
    valid: true,
    value: "employee_selected"
  });

  console.log("üì§ Sent widget submit payload.");
});
</script>

</body>
</html>
