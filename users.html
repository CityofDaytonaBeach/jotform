<!doctype html>
<html>
<head>
  <script src="//js.jotform.com/JotFormCustomWidget.min.js"></script>
</head>

<body>
<script>
const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";

let users = [];
let selectedEmployee = null;

async function loadUsers() {
  const res = await fetch(API_URL);
  users = await res.json();
  console.log("ğŸ“¦ Loaded employees:", users.length);
}

function buildUI() {
  const root = JFCustomWidget.getContainer();   // the REAL widget DOM

  const input = document.createElement("input");
  input.placeholder = "Search employee...";
  input.style.width = "100%";
  input.style.padding = "6px";
  input.style.border = "1px solid #ccc";
  input.style.borderRadius = "4px";
  input.id = "empSearch";

  const dropdown = document.createElement("div");
  dropdown.id = "dropArea";
  dropdown.style.position = "relative";

  root.appendChild(input);
  root.appendChild(dropdown);

  input.addEventListener("input", () => {
    const query = input.value.toLowerCase().trim();
    if (!query) return (dropdown.innerHTML = "");

    const matches = users.filter(u =>
      (u.displayname || "").toLowerCase().includes(query)
    ).slice(0, 8);

    console.log("ğŸ” Matches:", matches.length);
    buildDropdown(matches);
  });
}

function buildDropdown(matches) {
  const dropdown = document.getElementById("dropArea");
  dropdown.innerHTML = "";

  const list = document.createElement("div");
  list.style.position = "absolute";
  list.style.top = "100%";
  list.style.left = "0";
  list.style.right = "0";
  list.style.border = "1px solid #ccc";
  list.style.background = "#fff";
  list.style.zIndex = "99999";
  list.style.maxHeight = "180px";
  list.style.overflowY = "auto";

  matches.forEach(emp => {
    const item = document.createElement("div");
    item.textContent = emp.displayname;
    item.style.padding = "6px";
    item.style.cursor = "pointer";

    item.addEventListener("click", () => {
      console.log("ğŸŸ¢ Selected:", emp);
      selectedEmployee = emp;
      document.getElementById("empSearch").value = emp.displayname;
      dropdown.innerHTML = "";
      autoFill(emp);
    });

    item.onmouseover = () => item.style.background = "#f0f0f0";
    item.onmouseout = () => item.style.background = "#fff";

    list.appendChild(item);
  });

  dropdown.appendChild(list);
}

function autoFill(emp) {
  const pipeData = [
    emp.displayname,
    emp.mail,
    emp.jobtitle,
    emp.department,
    emp.manager,
    emp.managermail,
    emp.employeeId,
    emp.division
  ].join("|");

  console.log("ğŸ“¤ Pipe value:", pipeData);

  JFCustomWidget.setFieldsValueById([
    { id: "5", value: emp.displayname || "" },
    { id: "6", value: emp.mail || "" },
    { id: "7", value: emp.jobtitle || "" },
    { id: "8", value: emp.department || "" },
    { id: "9", value: emp.manager || "" },
    { id: "10", value: emp.managermail || "" },
    { id: "11", value: emp.employeeId || "" },
    { id: "12", value: emp.division || "" }
  ]);

  JFCustomWidget.storeToField("widget_input", pipeData);
}

function Widget() {
  this.init = async function() {
    await loadUsers();
    buildUI();
  };

  this.getData = function() {
    if (!selectedEmployee) return { valid: true, value: "" };
    const e = selectedEmployee;
    return {
      valid: true,
      value: [
        e.displayname, e.mail, e.jobtitle,
        e.department, e.manager, e.managermail,
        e.employeeId, e.division
      ].join("|")
    };
  };
}

JFCustomWidget.subscribe("ready", () => {
  const widget = new Widget();
  widget.init();

  JFCustomWidget.subscribe("submit", () => {
    JFCustomWidget.sendSubmit(widget.getData());
  });
});
</script>
</body>
</html>
