<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Employee Lookup Widget</title>

<!-- Jotform API -->
<script src="https://js.jotform.com/JotFormCustomWidget.min.js"></script>

<style>
  body {
    margin: 0;
    padding: 0;
    font-family: Arial, sans-serif;
  }

  #resultsContainer {
    position: relative;
    width: 100%;
  }

  #searchUser {
    width: 100%;
    padding: 6px;
    border: 1px solid #ccc;
    border-radius: 4px;
    box-sizing: border-box;
  }

  .dropdown {
    position: absolute;
    top: 100%;
    left: 0;
    right: 0;
    background: #fff;
    border: 1px solid #ccc;
    border-top: none;
    z-index: 9999;
    max-height: 180px;
    overflow-y: auto;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }

  .dropdown-item {
    cursor: pointer;
    padding: 6px 8px;
  }

  .dropdown-item:hover {
    background: #f0f0f0;
  }

  #permissionWarning {
    background: #fff3cd;
    color: #856404;
    padding: 10px;
    border: 1px solid #ffeeba;
    margin-top: 8px;
    border-radius: 4px;
    display: none;
  }
</style>
</head>

<body>

<div id="resultsContainer">
  <input type="text" id="searchUser" placeholder="Search employee..." autocomplete="off" />
  <div id="permissionWarning">
    <strong>Notice:</strong> Form field population is blocked.<br />
    Enable <em>"Access Form Fields"</em> inside your widget settings.
  </div>
</div>

<script>
/* ============================================================
   DIAGNOSTICS LOGGING
============================================================ */

console.clear();
console.log("ðŸ—‚ Employee Lookup Widget Loading");

window.addEventListener("error", e => console.log("ðŸŸ¥ JS ERROR:", e.message, e.error));
window.addEventListener("unhandledrejection", e => console.log("ðŸŸ¥ PROMISE ERROR:", e.reason));

console.log(
  "ðŸ” Iframe Check:",
  window.top === window.self ? "âŒ Not inside iframe" : "âœ… Running inside Jotform iframe"
);

/* Track fetches for sanity */
const originalFetch = window.fetch;
window.fetch = async (...args) => {
  console.log("ðŸŒ FETCH:", args[0]);
  const response = await originalFetch(...args);
  console.log("ðŸŒ RESPONSE:", args[0], response.status);
  return response;
};

/* ============================================================
   CONFIG
============================================================ */
const API_URL = "https://myefnonvpjbggqqurvhy.supabase.co/functions/v1/users";

let users = [];
let hasPermission = false;

const searchInput = document.getElementById("searchUser");
const resultsContainer = document.getElementById("resultsContainer");
const permissionWarning = document.getElementById("permissionWarning");

/* ============================================================
   LOAD USERS
============================================================ */
async function loadUsers() {
  console.log("ðŸŒ Fetching usersâ€¦");

  try {
    const res = await fetch(API_URL);
    console.log("ðŸŒ Status:", res.status);

    if (!res.ok) throw new Error("Fetch error: " + res.status);

    users = await res.json();
    console.log(`âœ… Loaded ${users.length} employees`);
  } catch (err) {
    console.error("âŒ Supabase fetch failed:", err);
  }
}

loadUsers();

/* ============================================================
   PERMISSION TEST
============================================================ */
function testJotformPermissions() {
  try {
    const testPayload = [{ id: "999", value: "test" }];
    JFCustomWidget.setFieldsValueById(testPayload);
    hasPermission = true;
    console.log("ðŸŸ© Permissions confirmed: Field population allowed");
  } catch (err) {
    hasPermission = false;
    permissionWarning.style.display = "block";
    console.warn("ðŸŸ¨ Permissions blocked. Widget cannot modify form fields.");
  }
}

/* ============================================================
   AUTOCOMPLETE
============================================================ */

let timer;

searchInput.addEventListener("input", e => {
  clearTimeout(timer);
  timer = setTimeout(() => handleSearch(e.target.value.trim().toLowerCase()), 120);
});

function handleSearch(query) {
  resultsContainer.querySelectorAll(".dropdown").forEach(d => d.remove());
  if (!query) return;

  const matches = users
    .filter(u => (u.displayname || "").toLowerCase().includes(query))
    .slice(0, 10);

  console.log("ðŸ” Matches:", matches);

  if (!matches.length) return;

  const dropdown = document.createElement("div");
  dropdown.className = "dropdown";

  matches.forEach(u => {
    const item = document.createElement("div");
    item.className = "dropdown-item";
    item.textContent = u.displayname;

    item.onclick = () => {
      searchInput.value = u.displayname;
      dropdown.remove();

      console.log("ðŸ“Œ Selected employee:", u);

      /* =======================================================
         FIELD POPULATION (ACTIVE MODE)
      ======================================================= */
      const fieldMap = [
        { id: "5", value: u.displayname },
        { id: "6", value: u.mail },
        { id: "7", value: u.jobtitle },
        { id: "8", value: u.department },
        { id: "9", value: u.manager },
        { id: "10", value: u.managermail },
        { id: "11", value: u.employeeId },
        { id: "12", value: u.division }
      ];

      if (hasPermission) {
        try {
          console.log("ðŸŸ¦ Updating form fields:", fieldMap);
          JFCustomWidget.setFieldsValueById(fieldMap);
          JFCustomWidget.requestFrameResize();
          console.log("ðŸŸ© Fields populated");
        } catch (err) {
          console.error("ðŸŸ¥ Field population failed:", err);
        }
      } else {
        console.warn("ðŸŸ¨ Field access denied by Jotform sandbox.");
        permissionWarning.style.display = "block";
      }

      /* Still send widget data */
      JFCustomWidget.sendData({
        valid: true,
        value: JSON.stringify(u)
      });
    };

    dropdown.appendChild(item);
  });

  resultsContainer.appendChild(dropdown);
}

/* Close dropdown if clicking outside */
document.addEventListener("click", e => {
  if (!resultsContainer.contains(e.target))
    resultsContainer.querySelectorAll(".dropdown").forEach(d => d.remove());
});

/* ============================================================
   JOTFORM WIDGET READY
============================================================ */
if (window.JFCustomWidget) {
  JFCustomWidget.subscribe("ready", () => {
    console.log("ðŸŸ¦ Widget Ready");
    testJotformPermissions();   // Permission verification
    JFCustomWidget.sendData({ valid: true, value: "" });
  });
}
</script>

</body>
</html>
